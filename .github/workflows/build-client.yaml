name: build-client

env:
  FIXED_VERSION: "1.0.0"

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-mac-ios-android:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      # 1) ç­¾å‡ºåˆ°å½“å‰è§¦å‘çš„æäº¤ï¼ˆtag æˆ–åˆ†æ”¯ï¼‰ï¼Œé¿å…å¼ºåˆ¶ master
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      # 2) è®¡ç®—å‘å¸ƒç”¨çš„ tagï¼šæ¨ tag ç”¨æ¨é€çš„ï¼Œæ‰‹åŠ¨è§¦å‘ç”¨ FIXED_VERSION
      - name: Compute release tag
        id: meta
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=v${FIXED_VERSION}" >> $GITHUB_OUTPUT
          fi

      # 3) APK ç­¾åï¼šæŠŠ base64 keystore å†™åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆ key.properties
      - name: Download Android keystore
        id: android_keystore
        uses: timheuer/base64-to-file@v1.2
        with:
          fileName: keystore.jks
          encodedString: ${{ secrets.KEYSTORE_BASE64 }}

      - name: Create key.properties
        run: |
          echo "storeFile=${{ steps.android_keystore.outputs.filePath }}" > simple_live_app/android/key.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> simple_live_app/android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> simple_live_app/android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> simple_live_app/android/key.properties

      # 4) Java 17ï¼ˆAGP/Kotlin å…¼å®¹ï¼‰ï¼Œå¹¶ç¼“å­˜ Gradle
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      # 5) Flutter ç¨³å®šç‰ˆ
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.x'
          cache: true

      # 6) å¯ç”¨ macOS æ¡Œé¢ï¼ˆç»™åç»­æ‰“åŒ…ç”¨ï¼‰
      - name: Enable Flutter Desktop
        run: flutter config --enable-macos-desktop

      # 7) **ä¿®å¤ Kotlin ç‰ˆæœ¬ä¸å…¼å®¹**ï¼ˆå…¼å®¹æ–°æ—§å·¥ç¨‹ç»“æ„ï¼‰ï¼Œå¹¶æ¸…ç† Gradle ç¼“å­˜
      - name: Patch Kotlin Gradle plugin to 1.8.22 and clean caches
        shell: bash
        run: |
          set -e
          ROOT="simple_live_app/android"
          # settings.gradle æ–°ç»“æ„ï¼ˆFlutter 3.19+ï¼‰
          if grep -q 'org.jetbrains.kotlin.android' "$ROOT/settings.gradle" 2>/dev/null; then
            sed -E -i '' 's/(id[[:space:]]+"org.jetbrains.kotlin.android"[[:space:]]+version[[:space:]]+")([^"]+)(")/\11.8.22\3/' "$ROOT/settings.gradle" || true
          fi
          # build.gradle è€ç»“æ„ï¼ˆext.kotlin_versionï¼‰
          if grep -q 'ext.kotlin_version' "$ROOT/build.gradle" 2>/dev/null; then
            sed -E -i '' "s/(ext\.kotlin_version\s*=\s*')[^']+(')/\1 1.8.22 \2/" "$ROOT/build.gradle" || true
          fi
          # æ¸…ç† Gradle ç¼“å­˜ï¼Œé¿å…æ—§ 1.6 å…ƒæ•°æ®é€ æˆå†²çª
          rm -rf ~/.gradle/caches

      # 8) æ‹‰åŒ…
      - name: Restore packages
        run: |
          cd simple_live_app
          flutter pub get

      # 9) ï¼ˆå¯é€‰ï¼‰å®‰è£… appdmg & flutter_distributor ç”¨äº macOS æ‰“åŒ…
      - name: Install packaging tools
        run: |
          npm install -g appdmg
          dart pub global activate flutter_distributor

      # 12) æ„å»º macOSï¼ˆdmg/zipï¼‰
      - name: Build macOS
        run: |
          cd simple_live_app
          flutter_distributor package --platform macos --targets dmg,zip --skip-clean

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac
          path: |
            simple_live_app/build/dist/*/*.dmg
            simple_live_app/build/dist/*/*.zip

      # 13) å‘å¸ƒåˆ° Releaseï¼ˆæ¨ tag ç”¨çœŸå® tagï¼›æ‰‹åŠ¨è§¦å‘ç”¨ FIXED_VERSIONï¼‰
      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.tag }}
          body: "Dev build ${{ steps.meta.outputs.tag }}"
          prerelease: true
          files: |
            simple_live_app/build/app/outputs/flutter-apk/app-x86_64-release.apk
            simple_live_app/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
            simple_live_app/build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
            simple_live_app/build/ios/iphoneos/ios_no_sign.ipa
            simple_live_app/build/dist/*/*.dmg
            simple_live_app/build/dist/*/*.zip

      - run: echo "ğŸ Job status is ${{ job.status }}."
